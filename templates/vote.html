{% extends 'base.html' %}
{% load static %}

{% block title %}Vote — {{ election.title }}{% endblock %}

{% block extra_css %}
<style>
    .vote-page { max-width: 1000px; margin: 0 auto; padding: 36px 20px; }

    /* ── Election Info Banner ── */
    .election-banner {
        background: var(--card-gradient); border: 1px solid var(--border-color);
        border-radius: 20px; padding: 28px 32px; margin-bottom: 28px; position: relative; overflow: hidden;
    }
    .election-banner::before {
        content: ''; position: absolute; right: -40px; top: -40px;
        width: 180px; height: 180px; border-radius: 50%;
        background: radial-gradient(circle, rgba(99,102,241,.2) 0%, transparent 70%);
    }
    .election-banner h2 { margin: 0; font-size: 22px; font-weight: 800; color: var(--text-color); }
    .election-banner p { margin: 6px 0 0; color: var(--text-muted); font-size: 14px; }
    .live-chip {
        display: inline-flex; align-items: center; gap: 6px;
        background: rgba(34,197,94,0.12); color: #22c55e;
        border: 1px solid rgba(34,197,94,0.3); padding: 5px 14px;
        border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 10px;
    }
    .live-dot { width: 7px; height: 7px; border-radius: 50%; background: #22c55e; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* ── Security Notice ── */
    .security-notice {
        background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3);
        border-radius: 14px; padding: 14px 18px; margin-bottom: 28px;
        display: flex; align-items: flex-start; gap: 12px; font-size: 13px; color: #f59e0b;
    }

    /* ── Section Title ── */
    .section-title {
        font-size: 18px; font-weight: 800; color: var(--text-color);
        margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
    }

    /* ── Candidate Cards ── */
    .candidates-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 18px; margin-bottom: 32px; }
    .candidate-card {
        background: var(--card-gradient); border: 2px solid var(--border-color);
        border-radius: 20px; padding: 28px 20px; text-align: center; cursor: pointer;
        position: relative; transition: border-color 0.2s, transform 0.2s, box-shadow 0.2s;
    }
    .candidate-card:hover {
        border-color: var(--accent); transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(99,102,241,0.2);
    }
    .candidate-card.selected {
        border-color: #22c55e;
        box-shadow: 0 0 0 3px rgba(34,197,94,0.2);
    }
    .select-check {
        position: absolute; top: 14px; right: 14px;
        width: 28px; height: 28px; border-radius: 50%;
        background: #22c55e; color: #fff; font-size: 13px;
        display: none; align-items: center; justify-content: center;
    }
    .candidate-card.selected .select-check { display: flex; }

    .candidate-avatar {
        width: 90px; height: 90px; border-radius: 50%;
        margin: 0 auto 16px; overflow: hidden;
        border: 3px solid var(--border-color);
        background: var(--input-bg); display: flex; align-items: center; justify-content: center;
    }
    .candidate-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .candidate-avatar i { font-size: 36px; color: var(--text-muted); }
    .candidate-card h5 { margin: 0 0 4px; font-size: 16px; font-weight: 700; color: var(--text-color); }
    .candidate-card .party { color: var(--text-muted); font-size: 13px; margin-bottom: 12px; }
    .party-symbol { width: 40px; height: 40px; object-fit: contain; margin-bottom: 10px; }
    .candidate-card .manifesto { font-size: 12px; color: var(--text-muted); line-height: 1.5; text-align: left; }

    .btn-select {
        padding: 10px 22px; border-radius: 12px; border: 1px solid var(--border-color);
        background: var(--input-bg); color: var(--text-muted); font-size: 14px; font-weight: 600;
        cursor: pointer; width: 100%; margin-top: 12px; transition: all 0.2s;
    }
    .btn-select:hover { border-color: var(--accent); color: var(--accent); }
    .candidate-card.selected .btn-select { background: rgba(34,197,94,0.1); border-color: #22c55e; color: #22c55e; }

    /* ── Confirm Panel ── */
    .confirm-panel {
        background: var(--card-gradient); border: 1px solid rgba(99,102,241,0.3);
        border-radius: 20px; padding: 28px 32px; margin-bottom: 28px; display: none; text-align: center;
        box-shadow: 0 0 0 1px rgba(99,102,241,0.15);
    }
    .confirm-panel h4 { font-size: 20px; font-weight: 800; color: var(--text-color); margin-bottom: 4px; }
    .confirm-panel p { color: var(--text-muted); margin-bottom: 20px; }
    .confirm-candidate-box {
        background: var(--input-bg); border: 1px solid var(--border-color);
        border-radius: 14px; padding: 18px 24px; display: inline-block; margin-bottom: 24px;
    }
    .confirm-candidate-box h5 { margin: 0 0 4px; font-size: 17px; font-weight: 700; color: var(--text-color); }
    .confirm-candidate-box span { color: var(--text-muted); font-size: 14px; }
    .confirm-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

    .btn-confirm {
        padding: 14px 32px; border-radius: 14px; border: none;
        background: #22c55e; color: #fff; font-size: 16px; font-weight: 700;
        cursor: pointer; box-shadow: 0 4px 15px rgba(34,197,94,0.3); transition: background 0.2s, transform 0.15s;
    }
    .btn-confirm:hover { background: #16a34a; transform: translateY(-2px); }
    .btn-cancel-vote {
        padding: 14px 32px; border-radius: 14px; border: 1px solid var(--border-color);
        background: transparent; color: var(--text-muted); font-size: 16px; font-weight: 700; cursor: pointer;
    }
    .btn-cancel-vote:hover { border-color: var(--danger); color: var(--danger); }

    /* ── Receipt overlay ── */
    .receipt-overlay {
        display: none; position: fixed; inset: 0; z-index: 500;
        background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
        align-items: center; justify-content: center;
    }
    .receipt-card {
        background: var(--card-gradient); border: 1px solid var(--border-color);
        border-radius: 28px; padding: 40px; max-width: 480px; width: 90%; text-align: center;
        box-shadow: var(--card-shadow);
    }
    .receipt-card .big-check { font-size: 52px; color: #22c55e; margin-bottom: 16px; }
    .receipt-card h3 { font-size: 22px; font-weight: 800; color: var(--text-color); margin-bottom: 8px; }
    .receipt-row { display: flex; justify-content: space-between; align-items: center;
        padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; }
    .receipt-row .rlabel { color: var(--text-muted); }
    .receipt-row .rval { font-weight: 600; color: var(--text-color); max-width: 60%; text-align: right; word-break: break-all; }
    .receipt-hash { font-family: monospace; font-size: 11px; color: #22c55e; }

    .no-candidates { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .no-candidates i { font-size: 48px; opacity: 0.4; display: block; margin-bottom: 16px; }
</style>
{% endblock %}

{% block content %}
<div class="vote-page" data-election-id="{{ election.id }}">

    <!-- Election Banner -->
    <div class="election-banner">
        <div class="live-chip"><div class="live-dot"></div> LIVE — VOTING OPEN</div>
        <h2><i class="fas fa-vote-yea me-2" style="color:var(--accent)"></i>{{ election.title }}</h2>
        <p>{{ election.description|truncatewords:30 }} &nbsp;·&nbsp; <i class="fas fa-clock me-1"></i>Ends {{ election.end_date|date:"M d, Y H:i" }}</p>
        <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:20px;">
            <small><i class="fas fa-users me-1"></i> <strong>{{ candidates.count }}</strong> Candidates</small>
            <small><i class="fas fa-map-marker-alt me-1"></i> <strong>{{ voter.constituency.name }}</strong></small>
            <small><i class="fas fa-user me-1"></i> Voter: <strong>{{ voter.name }}</strong></small>
        </div>
    </div>

    <!-- Security Notice -->
    <div class="security-notice">
        <i class="fas fa-shield-alt" style="margin-top:2px;"></i>
        <span>Your vote is completely anonymous and will be secured on blockchain. Once submitted, it cannot be changed. Please verify your selection carefully before confirming.</span>
    </div>

    <!-- Candidates -->
    <div class="section-title">
        <i class="fas fa-users" style="color:var(--accent)"></i>
        Select Your Candidate
    </div>

    {% if candidates %}
    <div class="candidates-grid">
        {% for candidate in candidates %}
        <div class="candidate-card" data-candidate-id="{{ candidate.id }}">
            <div class="select-check"><i class="fas fa-check"></i></div>
            <div class="candidate-avatar">
                {% if candidate.photo %}
                    <img src="{{ candidate.photo.url }}" alt="{{ candidate.name }}">
                {% else %}
                    <i class="fas fa-user"></i>
                {% endif %}
            </div>
            {% if candidate.party_symbol %}
                <img src="{{ candidate.party_symbol.url }}" class="party-symbol" alt="Party">
            {% endif %}
            <h5>{{ candidate.name }}</h5>
            <div class="party">{{ candidate.party_name }}</div>
            {% if candidate.manifesto %}
                <div class="manifesto">{{ candidate.manifesto|truncatewords:12 }}</div>
            {% endif %}
            <button class="btn-select candidate-select-btn" data-candidate-id="{{ candidate.id }}">
                <i class="fas fa-hand-pointer me-2"></i>Select
            </button>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-candidates">
        <i class="fas fa-exclamation-triangle"></i>
        <h4>No Candidates Available</h4>
        <p>There are no candidates registered for your constituency in this election.</p>
        <a href="{% url 'dashboard' %}" style="color:var(--accent);font-weight:600;text-decoration:none;">
            <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
    </div>
    {% endif %}

    <!-- Confirmation Panel -->
    <div class="confirm-panel" id="confirmationSection">
        <h4><i class="fas fa-check-circle me-2" style="color:var(--accent)"></i>Confirm Your Vote</h4>
        <p>You are about to vote for:</p>
        <div class="confirm-candidate-box">
            <h5 id="selectedCandidateName">-</h5>
            <span id="selectedCandidateParty">-</span>
        </div>
        <div class="confirm-actions">
            <button class="btn-cancel-vote" onclick="cancelSelection()"><i class="fas fa-times me-2"></i>Cancel</button>
            <button class="btn-confirm" onclick="confirmVote()"><i class="fas fa-vote-yea me-2"></i>Confirm Vote</button>
        </div>
    </div>

</div>

<!-- Receipt Overlay -->
<div class="receipt-overlay" id="receiptOverlay">
    <div class="receipt-card">
        <div class="big-check"><i class="fas fa-circle-check"></i></div>
        <h3>Vote Recorded on Blockchain</h3>
        <p style="color:var(--text-muted); margin-bottom:20px;">Your vote has been securely cast.</p>
        <div id="receiptDetails"></div>
        <a href="{% url 'dashboard' %}" style="display:block; margin-top:24px; padding:14px 32px; background:var(--accent); color:#fff; border-radius:14px; font-weight:700; text-decoration:none;">
            <i class="fas fa-home me-2"></i>Return to Dashboard
        </a>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedCandidateId = null;
let selectedCandidateData = null;

$(document).ready(function() {
    $('.candidate-card').click(function() { selectCandidate($(this).data('candidate-id'), this); });
    $('.candidate-select-btn').click(function(e) {
        e.stopPropagation();
        selectCandidate($(this).data('candidate-id'), $(this).closest('.candidate-card')[0]);
    });
});

function selectCandidate(id, card) {
    $('.candidate-card').removeClass('selected');
    $(card).addClass('selected');
    selectedCandidateId = id;
    selectedCandidateData = {
        id: id,
        name: $(card).find('h5').first().text().trim(),
        party: $(card).find('.party').text().trim()
    };
    $('#selectedCandidateName').text(selectedCandidateData.name);
    $('#selectedCandidateParty').text(selectedCandidateData.party);
    $('#confirmationSection').fadeIn(300);
    $('html,body').animate({ scrollTop: $('#confirmationSection').offset().top - 80 }, 400);
}

function cancelSelection() {
    $('.candidate-card').removeClass('selected');
    $('#confirmationSection').fadeOut(200);
    selectedCandidateId = null;
}

function confirmVote() {
    if (!selectedCandidateId) return;
    const btn = document.querySelector('.btn-confirm');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

    const electionId = parseInt(document.querySelector('.vote-page').getAttribute('data-election-id'));
    $.ajax({
        url: '{% url "api_cast_vote" %}',
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        data: JSON.stringify({ election_id: electionId, candidate_id: selectedCandidateId }),
        contentType: 'application/json',
        success: function(res) {
            if (res.success) {
                showReceipt(res);
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-vote-yea me-2"></i>Confirm Vote';
                alert(res.message || 'Failed to cast vote.');
            }
        },
        error: function() {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-vote-yea me-2"></i>Confirm Vote';
            alert('Network error. Please try again.');
        }
    });
}

function showReceipt(res) {
    const ts = res.timestamp ? new Date(res.timestamp).toLocaleString() : new Date().toLocaleString();
    $('#receiptDetails').html(`
        <div class="receipt-row"><span class="rlabel">Candidate</span><span class="rval">${selectedCandidateData.name}</span></div>
        <div class="receipt-row"><span class="rlabel">Party</span><span class="rval">${selectedCandidateData.party}</span></div>
        <div class="receipt-row"><span class="rlabel">Election</span><span class="rval">{{ election.title }}</span></div>
        <div class="receipt-row"><span class="rlabel">Timestamp</span><span class="rval">${ts}</span></div>
        ${res.receipt_hash ? `<div class="receipt-row"><span class="rlabel">Receipt</span><span class="rval receipt-hash">${res.receipt_hash}</span></div>` : ''}
        ${res.blockchain_hash ? `<div class="receipt-row"><span class="rlabel">Block Hash</span><span class="rval receipt-hash">${res.blockchain_hash}</span></div>` : ''}
    `);
    $('#receiptOverlay').css('display', 'flex');
    window.removeEventListener('beforeunload', warnLeave);
}

function warnLeave(e) {
    if (selectedCandidateId && !$('#receiptOverlay').is(':visible')) {
        e.preventDefault(); e.returnValue = '';
    }
}
window.addEventListener('beforeunload', warnLeave);
</script>
{% endblock %}
    
    .candidate-card {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }
    
    .candidate-card:hover {
        border-color: #007bff;
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
        transform: translateY(-3px);
    }
    
    .candidate-card.selected {
        border-color: #28a745;
        background-color: #f8fff9;
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.15);
    }
    
    .candidate-photo {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .party-symbol {
        width: 60px;
        height: 60px;
        object-fit: contain;
    }
    
    .vote-confirmation {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
    }
    
    .security-notice {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: #000;
        border-radius: 15px;
        padding: 15px;
    }
    
    .selection-indicator {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .candidate-card.selected .selection-indicator {
        opacity: 1;
    }
</style>
{% endblock %}