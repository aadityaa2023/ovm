{% extends 'platformadmindashboard/base.html' %}
{% block title %}Voter Detail — OVM Admin{% endblock %}
{% block page_title %}Voter Detail{% endblock %}
{% block active_voters %}active{% endblock %}

{% block content %}
<div class="d-flex align-items-center gap-3 mb-4">
    <a href="{% url 'platformadmin:voter_list' %}" class="btn btn-ghost btn-sm"><i class="fas fa-arrow-left"></i></a>
    <h4 class="mb-0">{{ voter.name }}</h4>
    <div class="ms-auto d-flex gap-2">
        <a href="{% url 'platformadmin:voter_edit' voter.id %}" class="btn btn-accent btn-sm">
            <i class="fas fa-edit me-1"></i>Edit
        </a>
    </div>
</div>

<div class="row g-4">
    <!-- Profile -->
    <div class="col-12 col-md-4">
        <div class="card mb-3">
            <div class="card-body text-center">
                {% if voter.face_image%}
                <img src="{{ voter.face_image.url }}"
                    style="width:100px;height:100px;border-radius:50%;object-fit:cover;border:3px solid #6366f1;"
                    alt="Face">
                {% else %}
                <div
                    style="width:100px;height:100px;border-radius:50%;background:rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:700;color:#6366f1;margin:0 auto;">
                    {{ voter.name|first|upper }}
                </div>
                {% endif %}
                <h5 class="mt-3 mb-0">{{ voter.name }}</h5>
                <div style="color:#8899b4;font-size:.8rem;" class="mt-1">{{ voter.aadhaar_number }}</div>
                <div class="mt-3">
                    {% if voter.is_verified%}
                    <span class="status-badge bg-success bg-opacity-10 text-success"><i
                            class="fas fa-shield-check me-1"></i>Verified</span>
                    {% else %}
                    <span class="status-badge bg-warning bg-opacity-10 text-warning">Not Verified</span>
                    {% endif %}
                    &nbsp;
                    {% if voter.has_voted%}
                    <span class="status-badge bg-info bg-opacity-10 text-info">Has Voted</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">Info</div>
            <div class="card-body p-0">
                {% with rows=voter.date_of_birth,voter.mobile_number,voter.email,voter.state,voter.constituency %}
                <div class="p-3" style="border-bottom:1px solid rgba(255,255,255,0.05)">
                    <div style="font-size:.7rem;color:#8899b4;">Date of Birth</div>
                    <div style="font-size:.85rem;">{{ voter.date_of_birth }}</div>
                </div>
                <div class="p-3" style="border-bottom:1px solid rgba(255,255,255,0.05)">
                    <div style="font-size:.7rem;color:#8899b4;">Mobile</div>
                    <div style="font-size:.85rem;">{{ voter.mobile_number }}</div>
                </div>
                <div class="p-3" style="border-bottom:1px solid rgba(255,255,255,0.05)">
                    <div style="font-size:.7rem;color:#8899b4;">Email</div>
                    <div style="font-size:.85rem;">{{ voter.email|default:"—" }}</div>
                </div>
                <div class="p-3" style="border-bottom:1px solid rgba(255,255,255,0.05)">
                    <div style="font-size:.7rem;color:#8899b4;">State</div>
                    <div style="font-size:.85rem;">{{ voter.state.name }}</div>
                </div>
                <div class="p-3" style="border-bottom:1px solid rgba(255,255,255,0.05)">
                    <div style="font-size:.7rem;color:#8899b4;">Constituency</div>
                    <div style="font-size:.85rem;">{{ voter.constituency.name }}</div>
                </div>
                <div class="p-3">
                    <div style="font-size:.7rem;color:#8899b4;">Address</div>
                    <div style="font-size:.82rem;">{{ voter.address }}</div>
                </div>
                {% endwith %}
            </div>
        </div>
    </div>

    <!-- Activity -->
    <div class="col-12 col-md-8">
        <!-- Votes -->
        <div class="card mb-3">
            <div class="card-header"><i class="fas fa-vote-yea me-2 text-warning"></i>Votes Cast ({{ votes.count }})
            </div>
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Election</th>
                            <th>Candidate</th>
                            <th>Time</th>
                            <th>Blockchain Hash</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in votes %}
                        <tr>
                            <td style="font-size:.82rem;">{{ v.election.title }}</td>
                            <td style="font-size:.82rem;">{{ v.candidate.name }}</td>
                            <td style="font-size:.75rem;color:#8899b4;">{{ v.cast_at|date:"M d, Y H:i" }}</td>
                            <td><span style="font-family:monospace;font-size:.7rem;color:#8899b4;">{{
                                    v.blockchain_hash|truncatechars:20 }}</span></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-3" style="color:#8899b4;">No votes cast</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Verifications -->
        <div class="card">
            <div class="card-header"><i class="fas fa-history me-2 text-primary"></i>Verification History ({{
                verifications.count }})</div>
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Confidence</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in verifications %}
                        <tr>
                            <td style="font-size:.82rem;">{{ v.get_verification_type_display }}</td>
                            <td>
                                {% if v.success%}
                                <span class="status-badge bg-success bg-opacity-10 text-success">Success</span>
                                {% else %}
                                <span class="status-badge bg-danger bg-opacity-10 text-danger">Failed</span>
                                {% endif %}
                            </td>
                            <td style="font-size:.82rem;">{% if v.confidence_score%}{{ v.confidence_score|floatformat:2
                                }}{% else %}—{% endif %}</td>
                            <td style="font-size:.75rem;color:#8899b4;">{{ v.attempted_at|date:"M d H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-3" style="color:#8899b4;">No verification attempts
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}